#!/usr/bin/env ruby
require "erb"
repo="sickp/alpine-nginx"

nginx_version = ARGV.first
case nginx_version
when /\A1\.10\.\d+\z/
  branch = "stable"
  tags = %w(1.10 stable)
when /\A1\.9\.\d+\z/
  branch = "mainline"
  tags = %w(1.9 mainline latest)
when /\A1\.8\.\d+\z/
  branch = "legacy"
  tags = %w(1.8 legacy)
else
  puts "Usage: build <nginx-version>"
  puts "  <nginx-version> = 1.8.x | 1.9.x | 1.11.x"
  exit 1
end

template = ERB.new(File.read(File.join(File.dirname(__FILE__), "templates", "Dockerfile.#{branch}.erb")))

# Plain version
base_image = "alpine:3.3"
dockerfile = File.join(File.dirname(__FILE__), "versions", nginx_version, "Dockerfile")
Dir.mkdir(File.dirname(dockerfile)) rescue nil
File.write(dockerfile, template.result(binding))

system("docker build -t #{repo}:#{nginx_version} --pull versions/#{nginx_version}") || abort
puts "Built #{repo}:#{nginx_version}"

# Kubernetes version
base_image = "janeczku/alpine-kubernetes:3.3"
dockerfile_k8s = File.join(File.dirname(__FILE__), "versions", "#{nginx_version}-k8s", "Dockerfile")
Dir.mkdir(File.dirname(dockerfile_k8s)) rescue nil
File.write(dockerfile_k8s, template.result(binding))

system("docker build -t #{repo}:#{nginx_version}-k8s --pull versions/#{nginx_version}-k8s") || abort
puts "Built #{repo}:#{nginx_version}-k8s"

# Tag
tags.each do |tag|
  system("docker tag #{repo}:#{nginx_version} #{repo}:#{tag}") || abort
  puts "Tagged #{repo}:#{tag}"
  system("docker tag #{repo}:#{nginx_version}-k8s #{repo}:#{tag}-k8s") || abort
  puts "Tagged #{repo}:#{tag}-k8s"
end
