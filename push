#!/usr/bin/env ruby
repo="sickp/alpine-nginx"

nginx_version = ARGV.first || ''
md = nginx_version.match(/\A((\d+\.\d+)\.\d+)-r\d+\z/)
case md && md[2]
when "1.11"
  puts "Pushing mainline..."
  tags = [ md[1], md[2], 'mainline', 'latest' ]
when "1.10"
  puts "Pushing stable..."
  tags = [ md[1], md[2], 'stable' ]
else
  puts "Usage: build {major}.{minor}.{teeny}-r{revision}"
  exit 1
end

system("docker image push #{repo}:#{nginx_version}") || abort
puts "Pushed #{repo}:#{nginx_version}"

tags.each do |tag|
  system("docker image tag #{repo}:#{nginx_version} #{repo}:#{tag}") || abort
  system("docker image push #{repo}:#{tag}") || abort
  system("docker image rm #{repo}:#{tag}") || abort
  puts "Pushed #{repo}:#{tag}"
end
